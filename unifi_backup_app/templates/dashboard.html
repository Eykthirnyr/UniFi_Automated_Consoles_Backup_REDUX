<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UniFi Automated Consoles Backup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml" />
  <script defer src="{{ url_for('static', filename='js/app.js') }}"></script>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1>UniFi Automated Consoles Backup</h1>
      <p>Modern dashboard for monitoring backups, schedules, and console activity in real time.</p>
    </div>
  </header>

  <main class="page-shell">
    <div class="flash-stack">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash-message {{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
      {% endwith %}
    </div>

    <section class="card-grid">
      <div class="card">
        <h2>Task Status</h2>
        <span id="task-status" class="badge">Idle</span>
        <p id="task-detail">No task is running.</p>
        <p id="task-subdetail" class="helper-text"></p>
        <p id="task-timing" class="helper-text"></p>
        <p id="queue-detail">Queue size: 0</p>
        <ul id="queue-list" class="queue-list"></ul>
      </div>
      <div class="card">
        <h2>Next Backup</h2>
        <p class="status-pill"><span class="status-dot yellow"></span><span id="next-backup">N/A</span></p>
        <p id="current-time" class="helper-text"></p>
        <p class="helper-text">Auto-calculated from your schedule settings.</p>
        <form method="POST" action="{{ url_for('start_schedule_now') }}">
          <button type="submit">Run Scheduled Backup Now</button>
        </form>
      </div>
      <div class="card">
        <h2>Login Status</h2>
        <p class="status-pill"><span id="login-status-dot" class="status-dot red"></span>Cookie session</p>
        <p id="login-status-text">Not logged in. Please do a manual server-side login.</p>
        <p id="cookie-check-time" class="helper-text"></p>
        <div class="button-row align-bottom">
          <form method="POST" action="{{ url_for('test_cookies') }}">
            <button type="submit">Test Cookies Now</button>
          </form>
          <form method="POST" action="{{ url_for('manual_relogin') }}">
            <button type="submit" class="secondary">Clear Cookies</button>
          </form>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <div>
          <h2>Consoles</h2>
          <p class="helper-text">Manage consoles and trigger backups.</p>
        </div>
        <div class="button-row">
          <form method="GET" action="{{ url_for('export_consoles') }}">
            <button type="submit" class="secondary">Export Consoles (JSON)</button>
          </form>
          <form method="POST" action="{{ url_for('reset_processes') }}">
            <button type="submit" class="secondary">Reset Processes</button>
          </form>
          <form method="GET" action="{{ url_for('download_today_backups') }}">
            <button type="submit" class="secondary">Download All Today's Backups (ZIP)</button>
          </form>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="console-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Backup URL</th>
              <th>Last Backup Status</th>
              <th>Last Backup Time</th>
              <th>Schedule</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="consoles-tbody"></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Add Console</h3>
        <form method="POST" action="{{ url_for('add_console') }}">
          <div class="form-grid">
            <div class="form-group">
              <label>Name</label>
              <input type="text" name="name" required />
            </div>
            <div class="form-group">
              <label>Backup URL</label>
              <input type="text" name="backup_url" required />
            </div>
          </div>
          <div style="margin-top: 16px;">
            <button type="submit">Add Console</button>
          </div>
        </form>
      </div>
    </section>

    <section class="section stacked-section">
      <div class="card">
        <h2>Schedules &amp; Time Zone</h2>
        <form method="POST" action="{{ url_for('update_schedule') }}">
          <div class="form-grid schedule-grid">
            <div class="form-group">
              <label>Enable Backup</label>
              <label class="checkbox-row">
                <input type="checkbox" name="backup_enabled" value="1" {% if appdata.schedule.backup_enabled %}checked{% endif %} />
                <span>Enable backup schedule</span>
              </label>
              <label>Backup Interval</label>
              <div class="input-row">
                <input type="number" name="backup_value" min="1" value="{{ appdata.schedule.backup_value }}" />
                <select name="backup_unit">
                <option value="minutes" {% if appdata.schedule.backup_unit == 'minutes' %}selected{% endif %}>Minutes</option>
                <option value="hours" {% if appdata.schedule.backup_unit == 'hours' %}selected{% endif %}>Hours</option>
                <option value="days" {% if appdata.schedule.backup_unit == 'days' %}selected{% endif %}>Days</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Enable Connectivity Check</label>
              <label class="checkbox-row">
                <input type="checkbox" name="check_enabled" value="1" {% if appdata.schedule.check_enabled %}checked{% endif %} />
                <span>Enable connectivity check</span>
              </label>
              <label>Check Interval</label>
              <div class="input-row">
                <input type="number" name="check_value" min="1" value="{{ appdata.schedule.check_value }}" />
                <select name="check_unit">
                <option value="minutes" {% if appdata.schedule.check_unit == 'minutes' %}selected{% endif %}>Minutes</option>
                <option value="hours" {% if appdata.schedule.check_unit == 'hours' %}selected{% endif %}>Hours</option>
                <option value="days" {% if appdata.schedule.check_unit == 'days' %}selected{% endif %}>Days</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Time Zone</label>
              <select name="tz_choice">
                {% for tz in available_tzs %}
                  <option value="{{ tz }}" {% if appdata.tz_choice == tz %}selected{% endif %}>{{ tz }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div style="margin-top: 16px;">
            <button type="submit">Update Schedules &amp; Timezone</button>
          </div>
        </form>
      </div>
    </section>

    <section class="section stacked-section" id="manual-cookie-upload">
      <div class="card">
        <h2>Manual Cookie Upload (Docker-safe)</h2>
        <p class="helper-text">
          Use this when the container cannot open a Chrome window. Export cookies as JSON
          and upload them to the container securely.
        </p>
        <form method="POST" action="{{ url_for('upload_cookies') }}" enctype="multipart/form-data">
          <div class="upload-row">
            <input type="file" name="cookies_file" accept="application/json" required />
            <button type="submit">Upload Cookies</button>
          </div>
        </form>
        <ul class="help-list">
          <li>Open <strong>https://unifi.ui.com</strong> in your browser and sign in.</li>
          <li>Install the <strong>Export Cookie JSON File</strong> extension.</li>
          <li>Export cookies for unifi.ui.com and upload the JSON here.</li>
        </ul>
        <p class="helper-text">
          Extension link: <a href="https://chromewebstore.google.com/detail/export-cookie-json-file-f/nmckokihipjgplolmcmjakknndddifde?hl=en" target="_blank" rel="noopener">Export Cookie JSON File</a>
        </p>
      </div>
    </section>

    <section class="section stacked-section">
      <div class="card">
        <h2>Bulk Console Import</h2>
        <p class="helper-text">
          Import many consoles from a JSON file (supports a top-level <code>consoles</code> list).
        </p>
        <form method="POST" action="{{ url_for('import_consoles') }}" enctype="multipart/form-data">
          <div class="upload-row">
            <input type="file" name="consoles_file" accept="application/json" required />
            <button type="submit">Import Consoles</button>
          </div>
          <label class="checkbox-row" style="margin-top: 8px;">
            <input type="checkbox" name="replace_existing" value="1" />
            <span>Replace existing consoles instead of merging by name.</span>
          </label>
        </form>
      </div>
    </section>

    <section class="section stacked-section">
      <div class="card">
        <h2>SMTP Notifications</h2>
        <p class="helper-text">
          Configure email alerts for cookie expiration and backup results. Times reflect your selected time zone: <strong>{{ tz_label }}</strong>.
        </p>
        <form method="POST" action="{{ url_for('update_smtp') }}">
          <div class="form-grid">
            <div class="form-group field-stack">
              <label>Enable SMTP</label>
              <label class="checkbox-row">
                <input type="checkbox" name="smtp_enabled" value="1" {% if appdata.smtp.enabled %}checked{% endif %} />
                <span>Enable email notifications</span>
              </label>
              <label>SMTP Host</label>
              <input type="text" name="smtp_host" value="{{ appdata.smtp.host }}" />
              <label>SMTP Port</label>
              <input type="number" name="smtp_port" value="{{ appdata.smtp.port }}" />
              <label>Use SSL</label>
              <label class="checkbox-row">
                <input type="checkbox" name="smtp_use_ssl" value="1" {% if appdata.smtp.use_ssl %}checked{% endif %} />
                <span>Use SSL/TLS</span>
              </label>
            </div>
            <div class="form-group field-stack">
              <label>Username</label>
              <input type="text" name="smtp_username" value="{{ appdata.smtp.username }}" />
              <label>Password</label>
              <input type="password" name="smtp_password" placeholder="{% if appdata.smtp.password %}Saved (hidden){% else %}Enter SMTP password{% endif %}" />
              {% if appdata.smtp.password %}
                <p class="helper-text">A password is saved and hidden for security. Leave blank to keep it.</p>
              {% endif %}
              <label>From Address</label>
              <input type="text" name="smtp_sender" value="{{ appdata.smtp.sender }}" />
              <label>Recipients (comma-separated)</label>
              <input type="text" name="smtp_recipients" value="{{ appdata.smtp.recipients }}" />
            </div>
            <div class="form-group field-stack">
              <label>Notification Types</label>
              <div class="checkbox-group">
                <label class="checkbox-row">
                  <input type="checkbox" name="notify_cookies_expired" value="1" {% if appdata.smtp.notify_cookies_expired %}checked{% endif %} />
                  <span>Cookies expired</span>
                </label>
                <label class="checkbox-row">
                  <input type="checkbox" name="notify_connectivity_failed" value="1" {% if appdata.smtp.notify_connectivity_failed %}checked{% endif %} />
                  <span>Connectivity check failed</span>
                </label>
                <label class="checkbox-row">
                  <input type="checkbox" name="notify_backup_failed" value="1" {% if appdata.smtp.notify_backup_failed %}checked{% endif %} />
                  <span>Backup failed</span>
                </label>
                <label class="checkbox-row">
                  <input type="checkbox" name="notify_backup_success" value="1" {% if appdata.smtp.notify_backup_success %}checked{% endif %} />
                  <span>Backup success</span>
                </label>
              </div>
            </div>
          </div>
          <div style="margin-top: 16px;">
            <div class="button-row">
              <button type="submit">Save SMTP Settings</button>
            </div>
          </div>
        </form>
        <form method="POST" action="{{ url_for('test_smtp') }}" class="button-row" style="margin-top: 12px;">
          <button type="submit" class="secondary">Send Test Email</button>
        </form>
      </div>
    </section>

    <section class="section">
      <div class="card">
        <div class="card-header-row">
          <h2>Logs (Last 300)</h2>
          <form method="GET" action="{{ url_for('download_logs') }}">
            <button type="submit" class="secondary">Download Logs</button>
          </form>
        </div>
        <ul class="log-list" id="logs-ul"></ul>
      </div>
    </section>

    <button id="back-to-top" class="back-to-top" type="button">Back to top</button>

    <div class="footer">
      <p>
        Made by <strong>Clément GHANEME</strong> (01/2025) —
        <a href="https://clement.business/" target="_blank" rel="noopener">https://clement.business/</a><br />
        Use at your own risk. Not responsible for any damages or data losses.
      </p>
    </div>
  </main>
</body>
</html>
